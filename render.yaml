services:
  - type: web
    name: starbeam-web
    runtime: node
    plan: starter
    autoDeploy: true
    buildCommand: pnpm install --frozen-lockfile && pnpm turbo run build --filter=@starbeam/web...
    startCommand: >-
      export DATABASE_URL=${DATABASE_URL:-$STARB_DATABASE_URL};
      export EMAIL_FROM=${EMAIL_FROM:-$STARB_EMAIL_FROM};
      i=0;
      until pnpm --filter @starbeam/db exec prisma migrate deploy; do
        i=$((i+1));
        if [ $i -ge 5 ]; then exit 1; fi;
        sleep $((i*3));
      done;
      pnpm --filter @starbeam/web start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false
      - key: AUTH_SECRET
        sync: false
      - key: AUTH_URL
        sync: false
      - key: NEXT_PUBLIC_WEB_ORIGIN
        sync: false
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: STARB_TOKEN_ENC_KEY_B64
        sync: false
      - key: OPENAI_API_KEY
        sync: false

  - type: worker
    name: starbeam-worker
    runtime: node
    plan: starter
    autoDeploy: true
    buildCommand: npm i -g @openai/codex@latest && codex --version && pnpm install --frozen-lockfile && pnpm turbo run build --filter=@starbeam/worker...
    startCommand: pnpm --filter @starbeam/worker start
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false
      - key: STARB_TOKEN_ENC_KEY_B64
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: STARB_CODEX_EXEC_ENABLED
        value: "1"
      - key: STARB_CODEX_WEB_SEARCH_ENABLED
        value: "1"
      - key: STARB_CODEX_REASONING_EFFORT
        value: low
      - key: STARB_CODEX_MODEL_DEFAULT
        value: gpt-5.2-codex
      # Phase 1 incremental sync: poll connectors to keep signals fresh.
      - key: STARB_CONNECTOR_POLL_ENABLED
        value: "1"
      - key: STARB_CONNECTOR_POLL_INTERVAL_MINS
        value: "15"
      - key: STARB_CONNECTOR_POLL_BATCH
        value: "20"
      - key: S3_ENDPOINT
        sync: false
      - key: S3_REGION
        sync: false
      - key: S3_ACCESS_KEY_ID
        sync: false
      - key: S3_SECRET_ACCESS_KEY
        sync: false
      - key: S3_BUCKET
        sync: false
      # Required for refresh-token exchange when syncing Google APIs.
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
